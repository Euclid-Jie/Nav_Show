<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>策略业绩报告</title>
    <script src="https://assets.pyecharts.org/assets/v5/echarts.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        h1,
        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            margin-bottom: 40px;
        }

        h2 {
            margin-top: 40px;
            text-align: left;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .card .period-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .card .date-range {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 15px;
        }

        .metric {
            margin-bottom: 10px;
        }

        .metric p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }

        .metric .value {
            font-size: 1.1em;
            font-weight: 700;
            margin-top: 5px;
            color: #333;
        }

        .metric .icon.positive {
            color: #d9534f;
        }

        .metric .icon.negative {
            color: #5cb85c;
        }

        .chart-section {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #chart-container {
            width: 100%;
            height: 700px;
        }

        .indicators-section {
            margin-top: 40px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
        }

        .indicators-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .indicators-section h2 {
            margin-top: 0;
            margin-bottom: 0;
        }

        .date-range-header {
            font-size: 0.7em;
            font-weight: normal;
            color: #666;
            margin-top: 5px;
        }

        .period-buttons {
            display: flex;
            gap: 5px;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }

        .period-btn {
            background-color: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .period-btn:hover {
            background-color: #dde2e7;
        }

        .period-btn.active {
            background-color: #ffffff;
            color: #007bff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* 改为三列 */
            gap: 20px;
            /* 减小间距 */
        }

        .indicator-column h3 {
            text-align: left;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #333;
        }

        .indicator-column .column-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: -15px;
            margin-bottom: 15px;
            height: 15px;
        }


        .indicator-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            margin-bottom: 15px;
        }

        p.metric-title {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 0.9em;
        }

        p.metric-value {
            margin: 0 0 8px 0;
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
        }

        p.metric-value.drawdown {
            color: #d9534f;
        }

        p.metric-benchmark {
            margin: 0;
            color: #777;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>策略业绩报告</h1>

        <div class="summary-cards">
            <div class="card">
                <p class="period-title">当日</p>
                <p class="date-range" id="summary-date-daily">--</p>
                <div class="metric">
                    <p>策略收益</p>
                    <p class="value" id="summary-strategy-daily">--</p>
                </div>
                <div class="metric">
                    <p>基准收益</p>
                    <p class="value" id="summary-benchmark-daily">--</p>
                </div>
                <div class="metric">
                    <p>超额收益</p>
                    <p class="value" id="summary-excess-daily">--</p>
                </div>
            </div>
            <div class="card">
                <p class="period-title">近一周</p>
                <p class="date-range" id="summary-date-weekly">--</p>
                <div class="metric">
                    <p>策略收益</p>
                    <p class="value" id="summary-strategy-weekly">--</p>
                </div>
                <div class="metric">
                    <p>基准收益</p>
                    <p class="value" id="summary-benchmark-weekly">--</p>
                </div>
                <div class="metric">
                    <p>超额收益</p>
                    <p class="value" id="summary-excess-weekly">--</p>
                </div>
            </div>
            <div class="card">
                <p class="period-title">近一月</p>
                <p class="date-range" id="summary-date-1m">--</p>
                <div class="metric">
                    <p>策略收益</p>
                    <p class="value" id="summary-strategy-1m">--</p>
                </div>
                <div class="metric">
                    <p>基准收益</p>
                    <p class="value" id="summary-benchmark-1m">--</p>
                </div>
                <div class="metric">
                    <p>超额收益</p>
                    <p class="value" id="summary-excess-1m">--</p>
                </div>
            </div>
            <div class="card">
                <p class="period-title">近三月</p>
                <p class="date-range" id="summary-date-3m">--</p>
                <div class="metric">
                    <p>策略收益</p>
                    <p class="value" id="summary-strategy-3m">--</p>
                </div>
                <div class="metric">
                    <p>基准收益</p>
                    <p class="value" id="summary-benchmark-3m">--</p>
                </div>
                <div class="metric">
                    <p>超额收益</p>
                    <p class="value" id="summary-excess-3m">--</p>
                </div>
            </div>
            <div class="card">
                <p class="period-title">今年以来</p>
                <p class="date-range" id="summary-date-ytd">--</p>
                <div class="metric">
                    <p>策略收益</p>
                    <p class="value" id="summary-strategy-ytd">--</p>
                </div>
                <div class="metric">
                    <p>基准收益</p>
                    <p class="value" id="summary-benchmark-ytd">--</p>
                </div>
                <div class="metric">
                    <p>超额收益</p>
                    <p class="value" id="summary-excess-ytd">--</p>
                </div>
            </div>
            <div class="card">
                <p class="period-title">成立以来</p>
                <p class="date-range" id="summary-date-all">--</p>
                <div class="metric">
                    <p>策略收益</p>
                    <p class="value" id="summary-strategy-all">--</p>
                </div>
                <div class="metric">
                    <p>基准收益</p>
                    <p class="value" id="summary-benchmark-all">--</p>
                </div>
                <div class="metric">
                    <p>超额收益</p>
                    <p class="value" id="summary-excess-all">--</p>
                </div>
            </div>
        </div>


        <div class="chart-section">
            <div id="chart-container"></div>
        </div>
        <div class="indicators-section">
            <div class="indicators-header">
                <h2>投资组合指标分析<p id="indicator-date-range" class="date-range-header">(成立以来)</p>
                </h2>
                <div class="period-buttons">
                    <button class="period-btn" data-period="1m">近一月</button>
                    <button class="period-btn" data-period="3m">近三月</button>
                    <button class="period-btn" data-period="6m">近六月</button>
                    <button class="period-btn" data-period="ytd">今年以来</button>
                    <button class="period-btn" data-period="1y">近一年</button>
                    <button class="period-btn active" data-period="all">成立以来</button>
                </div>
            </div>

            <div class="indicators-grid">
                <!-- 第一列: 核心表现 -->
                <div class="indicator-column">
                    <h3>核心表现</h3>
                    <p class="column-subtitle">策略与基准的绝对收益及风险</p>
                    <div class="indicator-card">
                        <p class="metric-title">总收益率</p>
                        <p class="metric-value" id="total_return_strategy">--</p>
                        <p class="metric-benchmark">基准: <span id="total_return_benchmark">--</span></p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">年化收益率</p>
                        <p class="metric-value" id="annualized_return_strategy">--</p>
                        <p class="metric-benchmark">基准: <span id="annualized_return_benchmark">--</span></p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">年化波动率</p>
                        <p class="metric-value" id="volatility_strategy">--</p>
                        <p class="metric-benchmark">基准: <span id="volatility_benchmark">--</span></p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">策略最大回撤</p>
                        <p class="metric-value drawdown" id="max_drawdown_strategy">--</p>
                        <p class="metric-benchmark">衡量策略历史最大跌幅</p>
                    </div>
                </div>

                <!-- 第二列: 风险调整后收益 -->
                <div class="indicator-column">
                    <h3>风险调整后收益</h3>
                    <p class="column-subtitle">注：无风险利率采用对应期SHIBOR均值</p>
                    <div class="indicator-card">
                        <p class="metric-title">夏普比率 (Sharpe Ratio)</p>
                        <p class="metric-value" id="sharpe_ratio_strategy">--</p>
                        <p class="metric-benchmark">基准: <span id="sharpe_ratio_benchmark">--</span></p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">索提诺比率 (Sortino Ratio)</p>
                        <p class="metric-value" id="sortino_ratio_strategy">--</p>
                        <p class="metric-benchmark">基准: <span id="sortino_ratio_benchmark">--</span></p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">科尔马比率 (Calmar Ratio)</p>
                        <p class="metric-value" id="calmar_ratio_strategy">--</p>
                        <p class="metric-benchmark">年化收益 / 最大回撤</p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">信息比率 (Information Ratio)</p>
                        <p class="metric-value" id="information_ratio">--</p>
                        <p class="metric-benchmark">主动管理能力的衡量</p>
                    </div>
                </div>

                <!-- 第三列: 相对基准分析 -->
                <div class="indicator-column">
                    <h3>相对基准分析</h3>
                    <p class="column-subtitle">策略相对基准的超额表现</p>
                    <div class="indicator-card">
                        <p class="metric-title">年化Alpha</p>
                        <p class="metric-value" id="annualized_alpha">--</p>
                        <p class="metric-benchmark">策略超越基准的年化回报</p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">Beta系数</p>
                        <p class="metric-value" id="beta">--</p>
                        <p class="metric-benchmark">对基准波动的敏感度</p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">跟踪误差</p>
                        <p class="metric-value" id="volatility_excess">--</p>
                        <p class="metric-benchmark">超额收益的年化波动率</p>
                    </div>
                    <div class="indicator-card">
                        <p class="metric-title">超额收益最大回撤</p>
                        <p class="metric-value drawdown" id="max_drawdown_excess">--</p>
                        <p class="metric-benchmark">超额收益曲线的最大跌幅</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 这些变量将在你的后端模板引擎中被替换
            const chartConfig = '{{ CHART_CONFIG_JSON }}';
            const allData = '{{ ALL_DATA_JSON }}';

            // 检查数据是否存在
            if (!chartConfig || !allData) {
                console.error("图表或指标数据未能正确加载，请检查后端模板变量。");
                return;
            }

            // 初始化 ECharts 图表
            const myChart = echarts.init(document.getElementById('chart-container'));
            myChart.setOption(chartConfig);
            window.addEventListener('resize', () => myChart.resize());

            // 简化获取元素的函数
            const el = (id) => document.getElementById(id);

            // 填充摘要
            const populateSummaryCards = () => {
                const periods = ['daily', 'weekly', '1m', '3m', 'ytd', 'all'];
                periods.forEach(period => {
                    const data = allData[period];
                    if (!data) return;

                    const formatDateRange = (start, end) => (start === end) ? start : `${start} ~ ${end}`;
                    el(`summary-date-${period}`).innerText = formatDateRange(data.start_date, data.end_date);

                    // 统一处理渲染逻辑
                    ['strategy', 'benchmark', 'excess'].forEach(type => {
                        let key, value;
                        if (type === 'strategy') key = 'total_return_strategy';
                        if (type === 'benchmark') key = 'total_return_benchmark';
                        if (type === 'excess') key = 'total_ari_excess_return';

                        value = data[key];
                        const element = el(`summary-${type}-${period}`);
                        const icon = value >= 0 ? '<span class="icon positive">▲</span>' : '<span class="icon negative">▼</span>';
                        element.innerHTML = `${icon} ${value.toFixed(2)}%`;
                    });
                });
            };

            // 更新指标数据的核心函数
            const updateIndicators = (period) => {
                const data = allData[period];
                if (!data) {
                    console.error(`未找到时间段 "${period}" 的数据`);
                    return;
                }

                // 格式化函数，方便复用
                const formatPercent = (value) => `${value.toFixed(2)}%`;
                const formatNumber = (value) => value.toFixed(2);

                // --- 更新标题日期范围 ---
                el('indicator-date-range').innerText = `(${data.start_date} 至 ${data.end_date}, ${data.days}个交易日)`;

                // --- 更新第一列: 核心表现 ---
                el('total_return_strategy').innerText = formatPercent(data.total_return_strategy);
                el('total_return_benchmark').innerText = formatPercent(data.total_return_benchmark);
                el('annualized_return_strategy').innerText = formatPercent(data.annualized_return_strategy);
                el('annualized_return_benchmark').innerText = formatPercent(data.annualized_return_benchmark);
                el('volatility_strategy').innerText = formatPercent(data.volatility_strategy);
                el('volatility_benchmark').innerText = formatPercent(data.volatility_benchmark);
                el('max_drawdown_strategy').innerText = formatPercent(data.max_drawdown_strategy);

                // --- 更新第二列: 风险调整后收益 ---
                el('sharpe_ratio_strategy').innerText = formatNumber(data.sharpe_ratio_strategy);
                el('sharpe_ratio_benchmark').innerText = formatNumber(data.sharpe_ratio_benchmark);
                el('sortino_ratio_strategy').innerText = formatNumber(data.sortino_ratio_strategy);
                el('sortino_ratio_benchmark').innerText = formatNumber(data.sortino_ratio_benchmark);
                el('calmar_ratio_strategy').innerText = formatNumber(data.calmar_ratio_strategy);
                el('information_ratio').innerText = formatNumber(data.information_ratio);

                // --- 更新第三列: 相对基准分析 ---
                el('annualized_alpha').innerText = formatPercent(data.annualized_alpha);
                el('beta').innerText = formatNumber(data.beta);
                el('volatility_excess').innerText = formatPercent(data.volatility_excess);
                el('max_drawdown_excess').innerText = formatPercent(data.max_drawdown_excess);
            };

            // 按钮点击事件绑定
            const buttons = document.querySelectorAll('.period-btn');
            buttons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const period = event.target.dataset.period;
                    buttons.forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    updateIndicators(period);
                });
            });

            // 页面加载后，默认显示"成立以来"的数据
            populateSummaryCards();
            updateIndicators('all');
        });
    </script>
</body>

</html>